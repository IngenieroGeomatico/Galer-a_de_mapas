<!DOCTYPE html>
<html>
  <head>
      <meta charset="UTF-8">
      <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0">
      <meta http-equiv="X-UA-Compatible" content="IE=edge" />

      <title>Visualizador base</title>

      <!-- fichero estilos -->
      <link href="https://componentes.cnig.es/api-core/assets/css/apiign.ol.min.css" rel="stylesheet" />

      <!-- Ficheros javascript de la API -->
      <script type="text/javascript" src="https://componentes.cnig.es/api-core/vendor/browser-polyfill.js"></script>          
      <script type="text/javascript" src="https://componentes.cnig.es/api-core/js/apiign.ol.min.js"></script>        
      <script type="text/javascript" src="https://componentes.cnig.es/api-core/js/configuration.js"></script>         
     
      <!-- Importación librerías propias -->
      <script type="text/javascript" src="../js/lib/transforms/formats.js"></script> 
      <script type="text/javascript" src="../js/lib/thematics/join.js"></script>          
     
      <!-- estilo básico -->
      <style>
          html,
          body {
              margin: 0;
              padding: 0;
              height: 100%;
          }
      </style>

  </head>
  <body>

      <!-- Contenedor principal del mapa -->
      <div id="mapa"></div>

      <script type="text/javascript">

        M.proxy(false)

        mapajs = M.map({
          container: "mapa",
          zoom:11,
          center:{ x: -409357.1616789646, y: 4929016.309020255 },
          controls:['attributions'],
          layers:[]
        });

        mapajs.addAttribution({ 
                name:"Autor:",
                description:" <a style='color: #0000FF' href='https://github.com/IngenieroGeomatico' target='_blank'>IngenieroGeomático</a> "
        })

        mapajs.addQuickLayers('Base_IGNBaseTodo_TMS') 
        

        // Para hacerlo mejor: https://www.w3schools.com/js/js_async.asp
        // M.proxy(true)
        // M.remote.get("https://datos.madrid.es/egob/catalogo/212531-10515086-calidad-aire-tiempo-real.csv",
        //   {}
        // ).then(function (res) {
        //   // Muestra un diálogo informativo con el resultado de la petición get
        //   console.log(res.text);
        //   M.proxy(false)
        // });

        // M.proxy(true)
        // M.remote.get("https://datos.madrid.es/egob/catalogo/212629-1-estaciones-control-aire.csv",
        //   {}
        // ).then(function (res) {
        //   // Muestra un diálogo informativo con el resultado de la petición get
        //   console.log(res.text);
        //   M.proxy(false)
        // });

        
        geojsonJoin = myFunction_JoinData() 
        geojsonJoin.then(()=>{
          // creamos la capa
          const capaEstaciones = new M.layer.GeoJSON({
              name: "Estaciones calidad del aire",
              source: geojsonJoin,
              extract:true,
              legend:"Estaciones calidad del aire",
              attribution:{ 
                name:"Estaciones:",
                description:" <a style='color: #0000FF' href='https://datos.madrid.es/portal/site/egob' target='_blank'>Ayuntamiento de Madrid</a> "
              }
          })

          // y la añadimos al mapa
          mapajs.addLayers(capaEstaciones);
        })


        // Funciones necesarias para el visualizador
        async function myFunction_JoinData() {

          let myPromise = new Promise(function(resolve) {

            M.proxy(true)
            M.remote.get("https://datos.madrid.es/egob/catalogo/212629-1-estaciones-control-aire.csv",).then(
                function (res) {
                  // Muestra un diálogo informativo con el resultado de la petición get
                  // console.log(res.text);
                  M.proxy(false)
                  resolve(res.text)
                });
            });
            value1_estaciones = await myPromise;
            geojsonEstaciones = csvToGeoJson(value1_estaciones,long="LONGITUD",lat="LATITUD")


            let myPromise2 = new Promise(function(resolve) {

                M.proxy(true)
                M.remote.get("https://datos.madrid.es/egob/catalogo/212531-10515086-calidad-aire-tiempo-real.csv",).then(
                    function (res) {
                      // Muestra un diálogo informativo con el resultado de la petición get
                      // console.log(res.text);
                      M.proxy(false)
                      resolve(res.text)
                    });
            });
            value2_datos = await myPromise2;

            jsonEstaciones = csvToJson(value2_datos)


            geojsonJoin = joinGeoJsonWithJson(geojsonEstaciones, jsonEstaciones, 'CODIGO_CORTO', 'ESTACION');

            console.log(geojsonJoin)


            return geojsonJoin
          }
 
      </script>
  </body>
</html>