<!DOCTYPE html>
<html>

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0">
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />

  <title>Calidad Aire Madrid</title>

  <!-- fichero estilos -->
  <link href="https://componentes.cnig.es/api-core/assets/css/apiign.ol.min.css" rel="stylesheet" />

  <!-- Ficheros javascript de la API-CNIG -->
  <script type="text/javascript" src="https://componentes.cnig.es/api-core/vendor/browser-polyfill.js"></script>
  <script type="text/javascript" src="https://componentes.cnig.es/api-core/js/apiign.ol.min.js"></script>
  <script type="text/javascript" src="https://componentes.cnig.es/api-core/js/configuration.js"></script>

  <!-- Extensiones de la API-CNIG -->
  <link href="https://componentes.cnig.es/api-core/plugins/modal/modal.ol.min.css" rel="stylesheet" />
  <script type="text/javascript" src="https://componentes.cnig.es/api-core/plugins/modal/modal.ol.min.js"></script>

  <link href="https://componentes.cnig.es/api-core/plugins/layerswitcher/layerswitcher.ol.min.css" rel="stylesheet" />
  <script type="text/javascript"
    src="https://componentes.cnig.es/api-core/plugins/layerswitcher/layerswitcher.ol.min.js"></script>


  <!-- Extensiones de la API-CNIG personalizadas -->
  <!-- extensión interpolar capa -->
  <link href="../ext/CalidadAireMadridTiempoReal/CalidadAireMadridTiempoReal.css" rel="stylesheet" />
  <script type="text/javascript" src="../ext/CalidadAireMadridTiempoReal/CalidadAireMadridTiempoReal.js"></script>
  
  <!-- Importación otras librerías-->
  <script type="text/javascript" src="../js/turf/turf_7.0.0.min.js.js"></script>
  <script type="text/javascript" src="../js/kriging/kriging.js"></script>

  <!-- Importación librerías propias -->
  <script type="text/javascript" src="../js/lib/transforms/formats.js"></script>
  <script type="text/javascript" src="../js/lib/thematics/join.js"></script>
  <script type="text/javascript" src="../js/lib/thematics/filter.js"></script>

  <!-- estilo básico -->
  <style>
    html,
    body {
      margin: 0;
      padding: 0;
      height: 100%;
    }
  </style>

</head>

<body>

  <!-- Div carga -->
  <div id="cargaSVG">
    <img src="../../img/iconos/gear-spinner.svg">
  </div>

  <!-- Contenedor principal del mapa -->
  <div id="mapa"></div>

  <script type="text/javascript">

    const SVGCarga = document.getElementById("cargaSVG")
    window.onload = (event) => {
      SVGCarga.hidden = true
    };

    M.proxy(false)

    mapajs = M.map({
      container: "mapa",
      zoom: 11,
      center: { x: -409357.1616789646, y: 4929016.309020255 },
      controls: ['attributions'],
      layers: []
    });

    mapajs.addAttribution({
      name: "Autor:",
      description: " <a style='color: #0000FF' href='https://github.com/IngenieroGeomatico' target='_blank'>IngenieroGeomático</a> "
    })

    mapajs.addQuickLayers('Base_IGNBaseTodo_TMS')


    // M.proxy(true)
    // M.remote.get("https://datos.madrid.es/egob/catalogo/212629-1-estaciones-control-aire.csv",
    //   {}
    // ).then(function (res) {
    //   // Muestra un diálogo informativo con el resultado de la petición get
    //   console.log(res.text);
    //   M.proxy(false)
    // });


    geojsonJoin = myFunction_JoinData()
    geojsonJoin.then(() => {

      // Estilos
      let estiloEstacion = new M.style.Generic({
          point: {
            icon: {
              src: '../img/iconos/house_wifi.svg',
              scale: 0.06,
            },

          }
        });
      
      let estiloMuncipio = new M.style.Generic({
          polygon: {
            fill: {
              opacity: 0.2,
            },
            stroke: {
              color: '#ff3c00',
              width: 4
            }
          }
        });

      let estiloEstacionesMedidas_1 = new M.style.Generic({
          polygon: {
            fill: {
              opacity: 0.7,
              color: function(feature) {
                valor = feature.getAttributes()[Object.keys(feature.getAttributes())[0]]
                valores = valor.split("-");

                console.log(valores)
                if(true){
                  return ;

                }else if(false) {

                }else{

                }
                        
              },
            },
            stroke: {
              color: '#616161',
              width: 4
            }
          },
          point:{
            label: {
              // Texto a escribir
              text: 'SO2',
              // Fuente y características
              font: 'bold 19px Comic Sans MS',
              // Color de la fuente. Hexadecimal, nominal
              color: '#FF0000' || 'red',
              // Factor de escala de la fuente
              scale: 0.9,
              // Halo de la fuente
              stroke: {
                // Color de relleno del halo. Hexadecimal, nominal
                color: 'yellow' || '#FFF000',
                // Grosor en píxeles del halo
                width: 2,
              },
              align: M.style.align.CENTER,
              baseline: M.style.baseline.MIDDLE,
            }
          }
      });

      // creamos la capa
      const capaEstaciones = new M.layer.GeoJSON({
            name: "Estaciones calidad del aire",
            source: geojsonJoin.stations,
            extract: true,
            legend: "Estaciones calidad del aire",
            attribution: {
              name: "Estaciones:",
              description: " <a style='color: #0000FF' href='https://datos.madrid.es/portal/site/egob' target='_blank'>Ayuntamiento de Madrid</a> "
            }
          },{
            style:estiloEstacion
      })

      const capaMunicipio = new M.layer.GeoJSON({
            name: "Municipio Madrid",
            source: geojsonJoin.municipio,
            extract: true,
            legend: "Municipio Madrid",
            attribution: {
              name: "Municipio:",
              description: " <a style='color: #0000FF' href='https://api-features.ign.es//collections/administrativeunit/items?limit=1&nameunit=Madrid&nationallevelname=Municipio' target='_blank'>IGN</a> "
            }
          },{
            style: estiloMuncipio
      })

      
      const capaEstacionesMedidas_1 = new M.layer.GeoJSON({
        name: "capaEstacionesMedidas_1",
        source: geojsonJoin.Medida_1,
        extract: true,
        legend: "Dióxido de Azufre",
        visibility:false,
        // attribution: {
        //   name: "Estaciones:",
        //   description: " <a style='color: #0000FF' href='https://datos.madrid.es/portal/site/egob' target='_blank'>Ayuntamiento de Madrid</a> "
        // }
      },{
        visibility:false,
        style: estiloEstacionesMedidas_1
      })
     
      // const capaEstacionesMedidas_1_interpolate = new M.layer.GeoJSON({
      //   name: "capaEstacionesMedidas_1_int",
      //   source: turf.isobands(
      //       turf.interpolate(geojsonJoin.Medida_1,0.1,{gridType: "points", property: "H01"}),
      //       [1,2,3,4,5,6,7,8,9,10],
      //       {zProperty:"H01"}
      //     ),
      //   extract: true,
      //   legend: "Dióxido de Azufre int", 
      //   // attribution: {
      //   //   name: "Estaciones:",
      //   //   description: " <a style='color: #0000FF' href='https://datos.madrid.es/portal/site/egob' target='_blank'>Ayuntamiento de Madrid</a> "
      //   // }
      // })

      const capaEstacionesMedidas_6 = new M.layer.GeoJSON({
        name: "capaEstacionesMedidas_6",
        source: geojsonJoin.Medida_6,
        extract: true,
        legend: "Monóxido de Carbono ",
        visibility:false,
        // attribution: {
        //   name: "Estaciones:",
        //   description: " <a style='color: #0000FF' href='https://datos.madrid.es/portal/site/egob' target='_blank'>Ayuntamiento de Madrid</a> "
        // }
      },{visibility:false})

      const capaEstacionesMedidas_7 = new M.layer.GeoJSON({
        name: "capaEstacionesMedidas_7",
        source: geojsonJoin.Medida_7,
        extract: true,
        legend: "Monóxido de Nitrógeno",
        visibility:false,
        // attribution: {
        //   name: "Estaciones:",
        //   description: " <a style='color: #0000FF' href='https://datos.madrid.es/portal/site/egob' target='_blank'>Ayuntamiento de Madrid</a> "
        // }
      },{visibility:false})

      const capaEstacionesMedidas_8 = new M.layer.GeoJSON({
        name: "capaEstacionesMedidas_8",
        source: geojsonJoin.Medida_8,
        extract: true,
        legend: "Dióxido de Nitrógeno",
        visibility:false,
        // attribution: {
        //   name: "Estaciones:",
        //   description: " <a style='color: #0000FF' href='https://datos.madrid.es/portal/site/egob' target='_blank'>Ayuntamiento de Madrid</a> "
        // }
      },{visibility:false})

      const capaEstacionesMedidas_9 = new M.layer.GeoJSON({
        name: "capaEstacionesMedidas_9",
        source: geojsonJoin.Medida_9,
        extract: true,
        legend: "Partículas < 2.5 μm ",
        visibility:false,
        // attribution: {
        //   name: "Estaciones:",
        //   description: " <a style='color: #0000FF' href='https://datos.madrid.es/portal/site/egob' target='_blank'>Ayuntamiento de Madrid</a> "
        // }
      },{visibility:false})

      const capaEstacionesMedidas_10 = new M.layer.GeoJSON({
        name: "capaEstacionesMedidas_10",
        source: geojsonJoin.Medida_10,
        extract: true,
        legend: "Partículas < 10 μm",
        visibility:false,
        // attribution: {
        //   name: "Estaciones:",
        //   description: " <a style='color: #0000FF' href='https://datos.madrid.es/portal/site/egob' target='_blank'>Ayuntamiento de Madrid</a> "
        // }
      },{visibility:false})

      const capaEstacionesMedidas_12 = new M.layer.GeoJSON({
        name: "capaEstacionesMedidas_12",
        source: geojsonJoin.Medida_12,
        extract: true,
        legend: "Óxidos de Nitrógeno",
        visibility:false,
        // attribution: {
        //   name: "Estaciones:",
        //   description: " <a style='color: #0000FF' href='https://datos.madrid.es/portal/site/egob' target='_blank'>Ayuntamiento de Madrid</a> "
        // }
      },{visibility:false})

      const capaEstacionesMedidas_14 = new M.layer.GeoJSON({
        name: "capaEstacionesMedidas_14",
        source: geojsonJoin.Medida_14,
        extract: true,
        legend: "Ozono",
        visibility:false,
        // attribution: {
        //   name: "Estaciones:",
        //   description: " <a style='color: #0000FF' href='https://datos.madrid.es/portal/site/egob' target='_blank'>Ayuntamiento de Madrid</a> "
        // }
      },{visibility:false})

      const capaEstacionesMedidas_20 = new M.layer.GeoJSON({
        name: "capaEstacionesMedidas_20",
        source: geojsonJoin.Medida_20,
        extract: true,
        legend: "Tolueno",
        visibility:false,
        // attribution: {
        //   name: "Estaciones:",
        //   description: " <a style='color: #0000FF' href='https://datos.madrid.es/portal/site/egob' target='_blank'>Ayuntamiento de Madrid</a> "
        // }
      },{visibility:false})

      const capaEstacionesMedidas_30 = new M.layer.GeoJSON({
        name: "capaEstacionesMedidas_30",
        source: geojsonJoin.Medida_30,
        extract: true,
        legend: "Benceno",
        visibility:false,
        // attribution: {
        //   name: "Estaciones:",
        //   description: " <a style='color: #0000FF' href='https://datos.madrid.es/portal/site/egob' target='_blank'>Ayuntamiento de Madrid</a> "
        // }
      },{visibility:false})


      const capaEstacionesMedidas_35 = new M.layer.GeoJSON({
        name: "capaEstacionesMedidas_35",
        source: geojsonJoin.Medida_35,
        extract: true,
        legend: "Etilbenceno",
        visibility:false,
        // attribution: {
        //   name: "Estaciones:",
        //   description: " <a style='color: #0000FF' href='https://datos.madrid.es/portal/site/egob' target='_blank'>Ayuntamiento de Madrid</a> "
        // }
      },{visibility:false})


      const capaEstacionesMedidas_37 = new M.layer.GeoJSON({
        name: "capaEstacionesMedidas_37",
        source: geojsonJoin.Medida_37,
        extract: true,
        legend: "Metaxileno",
        visibility:false,
        // attribution: {
        //   name: "Estaciones:",
        //   description: " <a style='color: #0000FF' href='https://datos.madrid.es/portal/site/egob' target='_blank'>Ayuntamiento de Madrid</a> "
        // }
      },{visibility:false})

      const capaEstacionesMedidas_38 = new M.layer.GeoJSON({
        name: "capaEstacionesMedidas_38",
        source: geojsonJoin.Medida_38,
        extract: true,
        legend: "Paraxileno",
        visibility:false,
        // attribution: {
        //   name: "Estaciones:",
        //   description: " <a style='color: #0000FF' href='https://datos.madrid.es/portal/site/egob' target='_blank'>Ayuntamiento de Madrid</a> "
        // }
      },{visibility:false})

      const capaEstacionesMedidas_39 = new M.layer.GeoJSON({
        name: "capaEstacionesMedidas_39",
        source: geojsonJoin.Medida_39,
        extract: true,
        legend: "Ortoxileno",
        visibility:false,
        // attribution: {
        //   name: "Estaciones:",
        //   description: " <a style='color: #0000FF' href='https://datos.madrid.es/portal/site/egob' target='_blank'>Ayuntamiento de Madrid</a> "
        // }
      },{visibility:false})


      const capaEstacionesMedidas_42 = new M.layer.GeoJSON({
        name: "capaEstacionesMedidas_42",
        source: geojsonJoin.Medida_42,
        extract: true,
        legend: "Hidrocarburos totales (hexano)",
        visibility:false,
        // attribution: {
        //   name: "Estaciones:",
        //   description: " <a style='color: #0000FF' href='https://datos.madrid.es/portal/site/egob' target='_blank'>Ayuntamiento de Madrid</a> "
        // }
      },{visibility:false})

      const capaEstacionesMedidas_43 = new M.layer.GeoJSON({
        name: "capaEstacionesMedidas_43",
        source: geojsonJoin.Medida_43,
        extract: true,
        legend: "Metano",
        visibility:false,
        // attribution: {
        //   name: "Estaciones:",
        //   description: " <a style='color: #0000FF' href='https://datos.madrid.es/portal/site/egob' target='_blank'>Ayuntamiento de Madrid</a> "
        // }
      },{visibility:false})

      const capaEstacionesMedidas_44 = new M.layer.GeoJSON({
        name: "capaEstacionesMedidas_44",
        source: geojsonJoin.Medida_44,
        extract: true,
        legend: "Hidrocarburos no metánicos (hexano)",
        visibility:false,
        // attribution: {
        //   name: "Estaciones:",
        //   description: " <a style='color: #0000FF' href='https://datos.madrid.es/portal/site/egob' target='_blank'>Ayuntamiento de Madrid</a> "
        // }
      },{visibility:false})

      const capaEstacionesMedidas_431 = new M.layer.GeoJSON({
        name: "capaEstacionesMedidas_431",
        source: geojsonJoin.Medida_431,
        extract: true,
        legend: "Metaparaxileno",
        visibility:false,
        // attribution: {
        //   name: "Estaciones:",
        //   description: " <a style='color: #0000FF' href='https://datos.madrid.es/portal/site/egob' target='_blank'>Ayuntamiento de Madrid</a> "
        // }
      },{visibility:false})




      arrayLayers = [
                    capaEstaciones,
                    capaMunicipio,      
                    capaEstacionesMedidas_1, capaEstacionesMedidas_6, 
                    capaEstacionesMedidas_7, capaEstacionesMedidas_8, capaEstacionesMedidas_9,
                    capaEstacionesMedidas_10, capaEstacionesMedidas_12, capaEstacionesMedidas_14,
                    capaEstacionesMedidas_20, capaEstacionesMedidas_30, capaEstacionesMedidas_35,
                    capaEstacionesMedidas_37, capaEstacionesMedidas_38, capaEstacionesMedidas_39,
                    capaEstacionesMedidas_42, capaEstacionesMedidas_43, capaEstacionesMedidas_44,
                    capaEstacionesMedidas_431
      ]


      // y la añadimos al mapa
      mapajs.addLayers(arrayLayers.reverse());
    })


    // Funciones necesarias para el visualizador
    async function myFunction_JoinData() {

      let myPromise = new Promise(function (resolve) {

        M.proxy(true)
        M.remote.get("https://datos.madrid.es/egob/catalogo/212629-1-estaciones-control-aire.csv",).then(
          function (res) {
            // Muestra un diálogo informativo con el resultado de la petición get
            // console.log(res.text);
            M.proxy(false)
            resolve(res.text)
          });
      });
      value1_estaciones = await myPromise;
      geojsonEstaciones = csvToGeoJson(value1_estaciones, long = "LONGITUD", lat = "LATITUD")


      let myPromise2 = new Promise(function (resolve) {

        M.proxy(true)
        M.remote.get("https://datos.madrid.es/egob/catalogo/212531-10515086-calidad-aire-tiempo-real.csv",).then(
          function (res) {
            // Muestra un diálogo informativo con el resultado de la petición get
            // console.log(res.text);
            M.proxy(false)
            resolve(res.text)
          });
      });
      value2_datos = await myPromise2;

      jsonEstaciones = csvToJson(value2_datos)

      let myPromise3 = new Promise(function (resolve) {
        M.proxy(true)
        M.remote.get("https://api-features.ign.es//collections/administrativeunit/items?f=json&limit=1&&nameunit=Madrid&&nationallevelname=Municipio",).then(
          function (res) {
            // Muestra un diálogo informativo con el resultado de la petición get
            // console.log(res.text);
            M.proxy(false)
            resolve(JSON.parse(res.text))
          });
      });
      value3_gjson_Madrid = await myPromise3;


      geojsonJoin = {}
      geojsonJoin.stations = geojsonEstaciones

      jsonEstacionesMedidas = joinJsonAndGeoJson(jsonEstaciones, geojsonEstaciones, 'ESTACION', 'CODIGO_CORTO')
      geojsonJoinMedidas = jsonToGeoJson(jsonEstacionesMedidas, geometry = "geometry")

      geojsonJoin.municipio = value3_gjson_Madrid

      geojsonJoin.Medidas = geojsonJoinMedidas
      geojsonJoin.Medida_1 = filterGeoJSON(geojsonJoinMedidas, "MAGNITUD", "1")
      geojsonJoin.Medida_6 = filterGeoJSON(geojsonJoinMedidas, "MAGNITUD", "6")
      geojsonJoin.Medida_7 = filterGeoJSON(geojsonJoinMedidas, "MAGNITUD", "7")
      geojsonJoin.Medida_8 = filterGeoJSON(geojsonJoinMedidas, "MAGNITUD", "8")
      geojsonJoin.Medida_9 = filterGeoJSON(geojsonJoinMedidas, "MAGNITUD", "9")
      geojsonJoin.Medida_10 = filterGeoJSON(geojsonJoinMedidas, "MAGNITUD", "10")
      geojsonJoin.Medida_12 = filterGeoJSON(geojsonJoinMedidas, "MAGNITUD", "12")
      geojsonJoin.Medida_14 = filterGeoJSON(geojsonJoinMedidas, "MAGNITUD", "14")
      geojsonJoin.Medida_20 = filterGeoJSON(geojsonJoinMedidas, "MAGNITUD", "20")
      geojsonJoin.Medida_30 = filterGeoJSON(geojsonJoinMedidas, "MAGNITUD", "30")
      geojsonJoin.Medida_35 = filterGeoJSON(geojsonJoinMedidas, "MAGNITUD", "35")
      geojsonJoin.Medida_37 = filterGeoJSON(geojsonJoinMedidas, "MAGNITUD", "37")
      geojsonJoin.Medida_38 = filterGeoJSON(geojsonJoinMedidas, "MAGNITUD", "38")
      geojsonJoin.Medida_39 = filterGeoJSON(geojsonJoinMedidas, "MAGNITUD", "39")
      geojsonJoin.Medida_42 = filterGeoJSON(geojsonJoinMedidas, "MAGNITUD", "42")
      geojsonJoin.Medida_43 = filterGeoJSON(geojsonJoinMedidas, "MAGNITUD", "43")
      geojsonJoin.Medida_44 = filterGeoJSON(geojsonJoinMedidas, "MAGNITUD", "44")
      geojsonJoin.Medida_431 = filterGeoJSON(geojsonJoinMedidas, "MAGNITUD", "431")
      // console.log(geojsonEstacionesMedidas)
      M.proxy(false)
      return geojsonJoin
    }


    // Extensiones
    M.proxy(false)
    const ext_Modal = new M.plugin.Modal({
      position: 'BL',
      helpLink: {
        es: '../html/modal_CalidadAireMadridTiempoReal.html'
      }
    });
    M.proxy(false)
    mapajs.addPlugin(ext_Modal);

    const ext_LayerSwitcher = new M.plugin.Layerswitcher({
      collapsed: false,
      position: 'TR',
      collapsible: true,
      isDraggable: true,
      modeSelectLayers: 'eyes',
      tools: ['transparency', 'legend', 'zoom', 'information', 'style', 'delete'],
      isMoveLayers: true,
      https: true,
      http: true,
      showCatalog: false,
      displayLabel: false,
    });
    mapajs.addPlugin(ext_LayerSwitcher);
    M.proxy(false)


    mapajs.addPlugin(miPlugin)



  </script>
</body>

</html>